---
title: Game Flow
description: Flusso completo di una partita dall'inizio alla fine
---

## Panoramica
Questo documento descrive il flusso completo di una partita di Rosiko dall'inizio alla fine.

---

## Fase 1: Lobby (WaitingForPlayers)

### Server
```
GameMode crea GameManager
â†“
GameManager inizializza configurazioni
â†“
Attende connessione giocatori
â†“
Ogni giocatore che si connette riceve PlayerState
```

### Client
```
Connessione al server
â†“
Riceve PlayerState con GameManagerPlayerID
â†“
Mostra schermata lobby
â†“
Attende inizio partita
```

**Condizione Avanzamento:**
Numero minimo giocatori connessi (es. 3+).

---

## Fase 2: Selezione Colori (ColorSelection)

### Server
```
ChangePhase(ColorSelection)
â†“
Multicast notifica a tutti i client
```

### Client
```
Mostra UI selezione colori
â†“
Player sceglie colore
â†“
Server_SelectPlayerColor(PlayerID, Color)
```

### Server Validation
```
Riceve richiesta selezione
â†“
Valida:
  - Ãˆ il turno di questo player?
  - Colore disponibile?
  - Player non ha giÃ  scelto?
â†“
Se OK:
  - PlayerState.SetArmyColor(Color)
  - Rimuovi colore da disponibili
  - Prossimo player
```

**Condizione Avanzamento:**
Tutti i giocatori hanno scelto colore.

### Trigger Assegnazione Obiettivi
```
Ultimo player sceglie colore
â†“
GameManager.AssignObjectivesToAllPlayers()
â†“
Filtra obiettivi validi
â†“
Shuffle deterministico
â†“
Assegna a ogni PlayerState
â†“
Replicazione (COND_OwnerOnly)
â†“
Client ricevono obiettivi
â†“
OnRep triggera UI update
```

---

## Fase 3: Distribuzione Iniziale (InitialDistribution)

### Server
```
ChangePhase(InitialDistribution)
â†“
DistributeInitialTerritories():
  - Shuffle territori
  - Assegna round-robin ai giocatori
  - Ogni territorio parte con 1 armata
â†“
Calcola truppe extra da piazzare:
  - In base a numero giocatori
  - Sottratto territori giÃ  posseduti
â†“
PlayerState.TroopsToPlace = Extra
```

### Client
```
Mostra mappa
â†“
Territories aggiornati con owner/color
â†“
UI mostra "Piazza X truppe rimanenti"
â†“
Player clicca territorio proprio
â†“
Server_PlaceTroops(PlayerID, TerritoryID, 1)
```

### Server
```
Valida piazzamento:
  - Ãˆ turno del player?
  - Territorio appartiene al player?
  - Ha truppe da piazzare?
â†“
Se OK:
  - TerritoryActor.ArmyCount++
  - PlayerState.TroopsToPlace--
  - Se 0 â†’ prossimo player
```

**Condizione Avanzamento:**
Tutti i giocatori hanno piazzato tutte le truppe.

---

## Fase 4: Turni di Gioco

Ogni turno ha 3 sotto-fasi:

### 4A: Reinforcement (Rinforzi)
```
Inizio turno player X
â†“
Calcola rinforzi:
  - Base: Territori Ã· 3 (min 3)
  - Bonus: Continenti controllati
  - Bonus: Carte territorio (futuro)
â†“
PlayerState.TroopsToPlace = Rinforzi
â†“
Player piazza truppe sui propri territori
â†“
Quando TroopsToPlace = 0 â†’ Fase Combat
```

### 4B: Combat (Attacco)
```
Player puÃ² attaccare territori adiacenti nemici
â†“
Player seleziona territorio attaccante
â†“
Player seleziona territorio difensore
â†“
Server_Attack(AttackerID, DefenderID, NumDice)
â†“
Server simula combattimento (dadi)
â†“
Aggiorna armate in base a risultato
â†“
Se difensore ridotto a 0:
  - Conquista territorio
  - Controlla vittoria (obiettivi)
â†“
Player puÃ² continuare ad attaccare
â†“
Quando finito â†’ Fase Fortification
```

### 4C: Fortification (Fortificazione)
```
Player puÃ² spostare armate tra propri territori adiacenti
â†“
Player seleziona territorio sorgente
â†“
Player seleziona territorio destinazione
â†“
Player sceglie quante armate spostare
â†“
Server_Fortify(SourceID, DestID, Amount)
â†“
Server valida e esegue
â†“
Player clicca "Fine Turno"
â†“
GameManager.EndTurn()
```

### Fine Turno
```
GameManager.EndTurn()
â†“
CheckPlayerObjectives(CurrentPlayer):
  - Valuta obiettivo principale
  - Valuta obiettivi secondari
  - Se principale completato â†’ VITTORIA
  - Se secondari completati â†’ +Punti
â†“
ControllaEliminazioni():
  - Se player perde ultimo territorio
  - Marca come eliminato
  - Rimuovi da TurnOrder
â†“
ProssimoGiocatore():
  - CurrentPlayerTurn++
  - Skip giocatori eliminati
  - Torna a Fase Reinforcement
```

---

## Fase 5: Fine Partita (GameOver)

### Condizioni Vittoria

**A) Obiettivo Principale Completato**
```
Player completa obiettivo principale
â†“
GameManager.CheckPlayerObjectives() rileva
â†“
ChangePhase(GameOver)
â†“
Multicast_NotifyVictory(WinnerPlayerID, "Main Objective")
â†“
Mostra schermata vittoria
```

**B) Ultimo Sopravvissuto**
```
Tutti gli altri player eliminati
â†“
GameManager rileva 1 solo player rimasto
â†“
ChangePhase(GameOver)
â†“
Multicast_NotifyVictory(LastPlayerID, "Survival")
```

**C) Tempo/Round Limite (Futuro)**
```
Raggiunto round N o tempo X
â†“
Calcola punti vittoria di tutti
â†“
Vince chi ha piÃ¹ punti
â†“
ChangePhase(GameOver)
â†“
Multicast_NotifyVictory(TopPlayerID, "Victory Points")
```

### Schermata Finale
```
Mostra:
  - Vincitore
  - Classifica finale
  - Statistiche (turni, battaglie, territori conquistati)
  - Obiettivi completati
  - Bottone "Torna a Lobby" / "Nuova Partita"
```

---

## Diagramma Stati

```
WaitingForPlayers
       â†“
ColorSelection
       â†“
   (Assegna Obiettivi)
       â†“
InitialDistribution
       â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ GAME LOOP  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
ReinforcementPlacement
       â†“
     Combat
       â†“
  Fortification
       â†“
   Check Vittoria?
   /           \
No             SÃ¬
â”‚               â†“
Turno     GameOver
Successivo
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚
 â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Stato Implementazione

âœ… Completato:
- Lobby e connessione
- Selezione colori
- Assegnazione obiettivi
- Distribuzione iniziale
- Piazzamento truppe
- Check obiettivi fine turno

ğŸ”¨ In sviluppo:
- Sistema combattimento completo
- Fortificazione
- Fine partita con classifica

ğŸ“… Futuro:
- Carte territorio
- Timer turni
- ModalitÃ  varianti
